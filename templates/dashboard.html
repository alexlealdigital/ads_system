&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;pt-br&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Dashboard de An√∫ncios&lt;/title&gt;
    &lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css&quot;&gt;
    &lt;style&gt;
        body { background-color: #f8f9fa; } /* Fundo leve para melhor visualiza√ß√£o de erros */
        .metric-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        .banner-bg { background-color: #e3f2fd; }
        .fullscreen-bg { background-color: #f0e6ff; } /* Cor diferente para debug visual */
        .chart-container { height: 300px; margin-bottom: 20px; background-color: #fff; padding:10px; border-radius: 5px;}

/* Estilos para a lista de an√∫ncios - mantidos para quando funcionar */
.ad-list-item-wrapper { /* Novo wrapper para facilitar debug CSS */
    border: 2px dashed blue; /* Borda de DEBUG VIS√çVEL */
    margin-bottom: 10px;
    padding: 10px;
    background-color: #fff;
}
.ad-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    border-bottom: 1px solid #eee;
}
.ad-list-item:last-child { border-bottom: none; }
.ad-actions { display: flex; gap: 5px; }
.btn-edit {
    background-color: #28a745; color: white; border-radius: 50%;
    width: 32px; height: 32px; padding: 0; display: inline-flex;
    align-items: center; justify-content: center; margin-right: 5px;
}
.btn-delete {
    background-color: #dc3545; color: white; border-radius: 50%;
    width: 32px; height: 32px; padding: 0; display: inline-flex;
    align-items: center; justify-content: center;
}
.debug-marker {
    background-color: #fff0b3; color: #333; padding: 5px; margin: 5px 0; border: 1px solid #ffd700; font-size:0.9em;
}
</style>


\</head\>
\<body\>
\<nav class="navbar navbar-expand-lg navbar-dark bg-primary"\>
\<div class="container"\>
\<a class="navbar-brand" href="/"\>Dashboard de An√∫ncios\</a\>
\<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="\#navbarNav"\>
\<span class="navbar-toggler-icon"\>\</span\>
\</button\>
\<div class="collapse navbar-collapse" id="navbarNav"\>
\<ul class="navbar-nav ms-auto"\>
\<li class="nav-item"\>\<a class="nav-link" href="/add-banner"\>Adicionar Banner\</a\>\</li\>
\<li class="nav-item"\>\<a class="nav-link" href="/add-fullscreen"\>Adicionar An√∫ncio Tela Cheia\</a\>\</li\>
\</ul\>
\</div\>
\</div\>
\</nav\>

<div class="container py-4">
<div class="row mb-4"><div class="col-12">
<h1 class="display-5 mb-4">M√©tricas de Desempenho</h1>
<p class="lead">Visualize o desempenho dos seus an√∫ncios em tempo real.</p>
</div></div>

<div class="row mb-4">
    <div class="col-md-6 mb-4"><div class="card metric-card banner-bg h-100"><div class="card-body">
        <h5 class="card-title"><span class="header-icon">üñºÔ∏è</span>Banners (360√ó47px)</h5>
        <div class="row mt-4">
            <div class="col-md-4 text-center"><h3>{{ metrics.banner.ads_count }}</h3><p class="text-muted">Total de An√∫ncios</p></div>
            <div class="col-md-4 text-center"><h3>{{ metrics.banner.total_impressions }}</h3><p class="text-muted">Impress√µes</p></div>
            <div class="col-md-4 text-center"><h3>{{ metrics.banner.ctr }}%</h3><p class="text-muted">Taxa de Cliques</p></div>
        </div>
    </div></div></div>
    <div class="col-md-6 mb-4"><div class="card metric-card fullscreen-bg h-100"><div class="card-body">
        <h5 class="card-title"><span class="header-icon">üì±</span>Tela Cheia (360√ó640px)</h5>
        <div class="row mt-4">
            <div class="col-md-4 text-center"><h3>{{ metrics.fullscreen.ads_count }}</h3><p class="text-muted">Total de An√∫ncios</p></div>
            <div class="col-md-4 text-center"><h3>{{ metrics.fullscreen.total_impressions }}</h3><p class="text-muted">Impress√µes</p></div>
            <div class="col-md-4 text-center"><h3>{{ metrics.fullscreen.ctr }}%</h3><p class="text-muted">Taxa de Cliques</p></div>
        </div>
    </div></div></div>
</div>

<div class="row mb-4">
    <div class="col-md-6 mb-4"><div class="card metric-card h-100"><div class="card-body">
        <h5 class="card-title mb-3">Desempenho de Banners</h5>
        <div class="chart-container"><canvas id="bannerChart"></canvas></div>
    </div></div></div>
    <div class="col-md-6 mb-4"><div class="card metric-card h-100"><div class="card-body">
        <h5 class="card-title mb-3">Desempenho de An√∫ncios Tela Cheia</h5>
        <div class="chart-container"><canvas id="fullscreenChart"></canvas></div>
    </div></div></div>
</div>

<div class="row">
    <div class="col-12 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title"><span class="header-icon">üñºÔ∏è</span>Detalhes dos Banners</h5>
                    <a href="/add-banner" class="btn btn-primary btn-sm"><i class="bi bi-plus-circle"></i> Adicionar Banner</a>
                </div>
                
                <div class="debug-marker">DEBUG HTML: Iniciando lista de banners. N√∫mero de ads: {{ metrics.banner.ads|length }}</div>
                <div class="debug-marker">DEBUG HTML: metrics.banner.ads existe? {% if metrics.banner.ads is defined %}SIM{% else %}N√ÉO{% endif %}</div>
                <div class="debug-marker">DEBUG HTML: metrics.banner.ads √© uma lista? {% if metrics.banner.ads is iterable and metrics.banner.ads is not string and metrics.banner.ads is not mapping %}SIM{% else %}N√ÉO{% endif %}</div>
                
                <div class="list-group">
                    {% if metrics.banner.ads and metrics.banner.ads|length > 0 %}
                        {% for ad in metrics.banner.ads %}
                        <div class="debug-marker" style="margin-left: 20px;">
                            DEBUG HTML (dentro do loop banner): ID {{ ad.id if ad.id is defined else 'N/A' }}, T√≠tulo: {{ ad.title if ad.title is defined else 'N/A' }}
                        </div>
                        <div class="ad-list-item-wrapper"> <div class="ad-list-item">
                                <div>
                                    <strong>{{ loop.index }}.</strong> {{ ad.title }}
                                </div>
                                <div class="ad-actions">
                                    <a href="/edit-banner/{{ ad.id }}" class="btn btn-edit" aria-label="Editar">
                                        <i class="bi bi-pencil-fill"></i>
                                    </a>
                                    <form action="/delete-banner/{{ ad.id }}" method="POST" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja deletar este banner?');">
                                        <button type="submit" class="btn btn-delete" aria-label="Deletar">
                                            <i class="bi bi-trash-fill"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="debug-marker">DEBUG HTML: A lista de banners est√° vazia ou n√£o √© uma lista iter√°vel.</div>
                        <div class="text-center py-3">
                            <p class="text-muted">Nenhum banner cadastrado.</p>
                        </div>
                    {% endif %}
                </div>
                <div class="debug-marker">DEBUG HTML: Fim da lista de banners.</div>
            </div>
        </div>
    </div>

    <div class="col-12 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title"><span class="header-icon">üì±</span>Detalhes dos An√∫ncios Tela Cheia</h5>
                    <a href="/add-fullscreen" class="btn btn-primary btn-sm"><i class="bi bi-plus-circle"></i> Adicionar An√∫ncio</a>
                </div>
                
                <div class="debug-marker">DEBUG HTML: Iniciando lista de an√∫ncios de tela cheia. N√∫mero de ads: {{ metrics.fullscreen.ads|length }}</div>
                <div class="debug-marker">DEBUG HTML: metrics.fullscreen.ads existe? {% if metrics.fullscreen.ads is defined %}SIM{% else %}N√ÉO{% endif %}</div>
                <div class="debug-marker">DEBUG HTML: metrics.fullscreen.ads √© uma lista? {% if metrics.fullscreen.ads is iterable and metrics.fullscreen.ads is not string and metrics.fullscreen.ads is not mapping %}SIM{% else %}N√ÉO{% endif %}</div>

                <div class="list-group">
                   {% if metrics.fullscreen.ads and metrics.fullscreen.ads|length > 0 %}
                        {% for ad in metrics.fullscreen.ads %}
                        <div class="debug-marker" style="margin-left: 20px;">
                            DEBUG HTML (dentro do loop fullscreen): ID {{ ad.id if ad.id is defined else 'N/A' }}, T√≠tulo: {{ ad.title if ad.title is defined else 'N/A' }}
                        </div>
                        <div class="ad-list-item-wrapper"> <div class="ad-list-item">
                                <div>
                                    <strong>{{ loop.index }}.</strong> {{ ad.title }}
                                </div>
                                <div class="ad-actions">
                                    <a href="/edit-fullscreen/{{ ad.id }}" class="btn btn-edit" aria-label="Editar">
                                        <i class="bi bi-pencil-fill"></i>
                                    </a>
                                    <form action="/delete-fullscreen/{{ ad.id }}" method="POST" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja deletar este an√∫ncio?');">
                                        <button type="submit" class="btn btn-delete" aria-label="Deletar">
                                            <i class="bi bi-trash-fill"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="debug-marker">DEBUG HTML: A lista de an√∫ncios de tela cheia est√° vazia ou n√£o √© uma lista iter√°vel.</div>
                        <div class="text-center py-3">
                            <p class="text-muted">Nenhum an√∫ncio de tela cheia cadastrado.</p>
                        </div>
                    {% endif %}
                </div>
                 <div class="debug-marker">DEBUG HTML: Fim da lista de an√∫ncios de tela cheia.</div>
            </div>
        </div>
    </div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <script>
console.log("--- DEBUG JS: Script principal do dashboard.html iniciado ---");

function getSafeData(dataFromJinja, attribute) {
    if (!Array.isArray(dataFromJinja)) {
        console.warn(`DEBUG JS: dataFromJinja para '${attribute}' n√£o √© um array. Recebido:`, dataFromJinja);
        return [];
    }
    return dataFromJinja.map(item => (item && item[attribute] !== undefined) ? item[attribute] : (attribute === 'title' ? 'T√≠tulo N/A' : 0));
}

function getSafeAdsArray(adsFromJinja) {
    let data = [];
    try {
        // Tenta usar os dados diretamente se j√° forem um array
        if (Array.isArray(adsFromJinja)) {
            data = adsFromJinja;
        } else if (typeof adsFromJinja === 'string' && adsFromJinja.trim() !== '') {
            // Se for uma string (resultado do |tojson|safe), tenta parsear
            data = JSON.parse(adsFromJinja);
            if (!Array.isArray(data)) data = []; // Garante que √© um array ap√≥s o parse
        }
    } catch (e) {
        console.error("DEBUG JS: Erro ao processar adsFromJinja:", adsFromJinja, "Erro:", e);
        data = []; // Retorna array vazio em caso de erro
    }
    return Array.isArray(data) ? data : [];
}

// Tenta obter os dados dos an√∫ncios
const rawBannerAds = {{ metrics.banner.ads | default([]) | tojson | safe }};
const rawFullscreenAds = {{ metrics.fullscreen.ads | default([]) | tojson | safe }};

console.log("DEBUG JS: rawBannerAds (do Jinja):", typeof rawBannerAds, rawBannerAds);
console.log("DEBUG JS: rawFullscreenAds (do Jinja):", typeof rawFullscreenAds, rawFullscreenAds);

const bannerAds = getSafeAdsArray(rawBannerAds);
const fullscreenAds = getSafeAdsArray(rawFullscreenAds);

console.log("DEBUG JS: bannerAds (processado):", JSON.parse(JSON.stringify(bannerAds)));
console.log("DEBUG JS: fullscreenAds (processado):", JSON.parse(JSON.stringify(fullscreenAds)));

const bannerData = {
    labels: getSafeData(bannerAds, 'title'),
    datasets: [
        {
            label: 'Impress√µes',
            data: getSafeData(bannerAds, 'impressions'),
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        },
        {
            label: 'Cliques',
            data: getSafeData(bannerAds, 'clicks'),
            backgroundColor: 'rgba(255, 99, 132, 0.5)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
        }
    ]
};

const fullscreenData = {
    labels: getSafeData(fullscreenAds, 'title'),
    datasets: [
        {
            label: 'Impress√µes',
            data: getSafeData(fullscreenAds, 'impressions'),
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        },
        {
            label: 'Cliques',
            data: getSafeData(fullscreenAds, 'clicks'),
            backgroundColor: 'rgba(255, 99, 132, 0.5)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
        }
    ]
};

console.log("DEBUG JS: Dados FINAIS para o gr√°fico de Banners:", JSON.parse(JSON.stringify(bannerData)));
console.log("DEBUG JS: Dados FINAIS para o gr√°fico de Tela Cheia:", JSON.parse(JSON.stringify(fullscreenData)));

const chartConfig = {
    type: 'bar',
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
        plugins: { tooltip: { callbacks: {
            label: function(context) {
                let label = context.dataset.label || '';
                if (label) { label += ': '; }
                if (context.parsed.y !== null) { label += context.parsed.y; }
                return label;
            }
        }}}
    }
};

window.addEventListener('load', function() {
    console.log("--- DEBUG JS: Evento window.load disparado. Inicializando gr√°ficos. ---");
    
    try {
        if (typeof Chart === 'undefined') {
            console.error("DEBUG_ERROR: Chart.js n√£o est√° definido. Verifique se o script foi carregado.");
            return;
        }

        if (document.getElementById('bannerChart')) {
            const bannerCtx = document.getElementById('bannerChart').getContext('2d');
            if (bannerCtx) {
                console.log("DEBUG JS: Contexto do gr√°fico de banner (bannerCtx) encontrado. Criando gr√°fico.");
                new Chart(bannerCtx, { ...chartConfig, data: bannerData });
            } else {
                console.error("DEBUG_ERROR: Falha ao obter contexto 2D para 'bannerChart'.");
            }
        } else {
            console.error("DEBUG_ERROR: Elemento canvas 'bannerChart' n√£o encontrado!");
        }
        
        if (document.getElementById('fullscreenChart')) {
            const fullscreenCtx = document.getElementById('fullscreenChart').getContext('2d');
            if (fullscreenCtx) {
                console.log("DEBUG JS: Contexto do gr√°fico de tela cheia (fullscreenCtx) encontrado. Criando gr√°fico.");
                new Chart(fullscreenCtx, { ...chartConfig, data: fullscreenData });
            } else {
                console.error("DEBUG_ERROR: Falha ao obter contexto 2D para 'fullscreenChart'.");
            }
        } else {
            console.error("DEBUG_ERROR: Elemento canvas 'fullscreenChart' n√£o encontrado!");
        }
    } catch (error) {
        console.error("DEBUG_ERROR: Erro ao inicializar os gr√°ficos:", error);
    }
});
</script>


\</body\>
\</html\>
